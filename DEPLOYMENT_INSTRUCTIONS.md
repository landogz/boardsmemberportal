# Laravel Application Deployment Instructions

Complete guide for deploying the Board Member Portal to your domain and hosting.

## Prerequisites

- SSH access to your hosting server
- PHP 8.2+ installed
- Composer installed
- MySQL/MariaDB database
- Node.js and npm (for asset compilation)
- Git installed on server
- Domain name configured and pointing to your server

---

## Step 1: Connect to Your Server

```bash
ssh username@your-domain.com
# or
ssh username@your-server-ip
```

---

## Step 2: Clone the Repository

```bash
# Navigate to your web root directory (usually public_html, www, or htdocs)
cd /path/to/your/web/root

# Clone the repository
git clone https://github.com/landogz/boardsmemberportal.git

# Navigate into the project directory
cd boardsmemberportal
```

---

## Step 3: Install PHP Dependencies

```bash
# Install Composer dependencies
composer install --optimize-autoloader --no-dev

# If composer is not installed globally, download it first:
# curl -sS https://getcomposer.org/installer | php
# php composer.phar install --optimize-autoloader --no-dev
```

---

## Step 4: Environment Configuration

```bash
# Copy the environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Edit the .env file with your configuration
nano .env
# or
vi .env
```

### Required .env Configuration:

```env
APP_NAME="Board Member Portal"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=https://your-domain.com

LOG_CHANNEL=stack
LOG_LEVEL=error

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database_name
DB_USERNAME=your_database_user
DB_PASSWORD=your_database_password

BROADCAST_DRIVER=reverb
REVERB_APP_ID=your-app-id
REVERB_APP_KEY=your-app-key
REVERB_APP_SECRET=your-app-secret
REVERB_HOST=your-domain.com
REVERB_PORT=8080
REVERB_SCHEME=https

CACHE_DRIVER=file
QUEUE_CONNECTION=database
SESSION_DRIVER=file
SESSION_LIFETIME=120

MAIL_MAILER=smtp
MAIL_HOST=your-smtp-host
MAIL_PORT=587
MAIL_USERNAME=your-email@domain.com
MAIL_PASSWORD=your-email-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@your-domain.com
MAIL_FROM_NAME="${APP_NAME}"

FILESYSTEM_DISK=local
```

**Important:** Replace all placeholder values with your actual configuration.

---

## Step 5: Database Setup

```bash
# Create database (if not already created via cPanel/phpMyAdmin)
# You may need to do this via your hosting control panel

# Run migrations
php artisan migrate --force

# Seed the database (optional, for initial setup)
php artisan db:seed --class=RolePermissionSeeder
php artisan db:seed --class=GovernmentAgencySeeder
```

---

## Step 6: Storage and Cache Setup

```bash
# Create symbolic link for storage
php artisan storage:link

# Clear and cache configuration
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Clear application cache
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

---

## Step 7: Install and Build Frontend Assets

```bash
# Install Node.js dependencies
npm install

# Build production assets
npm run build

# Or if you need to watch for changes during development:
# npm run dev
```

---

## Step 8: Set Permissions

```bash
# Set proper permissions for storage and cache directories
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache

# If www-data doesn't work, try your web server user:
# chown -R apache:apache storage bootstrap/cache
# or
# chown -R nginx:nginx storage bootstrap/cache
```

---

## Step 9: Configure Web Server

### For Apache (.htaccess should already be in public folder)

Create or update your Apache virtual host configuration:

```apache
<VirtualHost *:80>
    ServerName your-domain.com
    ServerAlias www.your-domain.com
    
    DocumentRoot /path/to/boardsmemberportal/public
    
    <Directory /path/to/boardsmemberportal/public>
        AllowOverride All
        Require all granted
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

Enable mod_rewrite:
```bash
sudo a2enmod rewrite
sudo systemctl restart apache2
```

### For Nginx

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    root /path/to/boardsmemberportal/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

---

## Step 10: Setup Laravel Reverb (WebSocket Server)

### Install Reverb

```bash
# Reverb should already be in composer.json, but if not:
composer require laravel/reverb

# Publish Reverb configuration
php artisan reverb:install
```

### Configure Reverb

Edit `config/reverb.php` or set in `.env`:

```env
REVERB_APP_ID=your-app-id
REVERB_APP_KEY=your-app-key
REVERB_APP_SECRET=your-app-secret
REVERB_HOST=your-domain.com
REVERB_PORT=8080
REVERB_SCHEME=https
```

### Run Reverb as a Service

Create a systemd service file for Reverb:

```bash
sudo nano /etc/systemd/system/reverb.service
```

Add the following:

```ini
[Unit]
Description=Laravel Reverb Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/boardsmemberportal
ExecStart=/usr/bin/php artisan reverb:start --host=0.0.0.0 --port=8080
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Enable and start the service:

```bash
sudo systemctl daemon-reload
sudo systemctl enable reverb
sudo systemctl start reverb
sudo systemctl status reverb
```

### Alternative: Run Reverb with Supervisor

Install Supervisor:

```bash
sudo apt-get install supervisor
```

Create supervisor config:

```bash
sudo nano /etc/supervisor/conf.d/reverb.conf
```

Add:

```ini
[program:reverb]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/boardsmemberportal/artisan reverb:start --host=0.0.0.0 --port=8080
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/path/to/boardsmemberportal/storage/logs/reverb.log
stopwaitsecs=3600
```

Start supervisor:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start reverb:*
```

---

## Step 11: Setup Queue Workers

Laravel uses queues for background jobs. Set up a queue worker:

### Using Supervisor (Recommended)

```bash
sudo nano /etc/supervisor/conf.d/laravel-worker.conf
```

Add:

```ini
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/boardsmemberportal/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/path/to/boardsmemberportal/storage/logs/worker.log
stopwaitsecs=3600
```

Start:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start laravel-worker:*
```

### Using systemd

```bash
sudo nano /etc/systemd/system/laravel-worker.service
```

Add:

```ini
[Unit]
Description=Laravel Queue Worker
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/boardsmemberportal
ExecStart=/usr/bin/php artisan queue:work --sleep=3 --tries=3
Restart=always

[Install]
WantedBy=multi-user.target
```

Enable and start:

```bash
sudo systemctl daemon-reload
sudo systemctl enable laravel-worker
sudo systemctl start laravel-worker
```

---

## Step 12: Setup Task Scheduler (Cron)

Laravel's scheduler needs to run every minute. Add to crontab:

```bash
crontab -e
```

Add this line (replace with your actual path):

```cron
* * * * * cd /path/to/boardsmemberportal && php artisan schedule:run >> /dev/null 2>&1
```

Or for a specific user (www-data):

```bash
sudo crontab -u www-data -e
```

---

## Step 13: SSL Certificate (HTTPS)

### Using Let's Encrypt (Certbot)

```bash
# Install Certbot
sudo apt-get install certbot python3-certbot-apache
# or for Nginx:
sudo apt-get install certbot python3-certbot-nginx

# Obtain certificate
sudo certbot --apache -d your-domain.com -d www.your-domain.com
# or for Nginx:
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# Auto-renewal (should be set up automatically)
sudo certbot renew --dry-run
```

### Update .env for HTTPS

```env
APP_URL=https://your-domain.com
REVERB_SCHEME=https
```

---

## Step 14: Firewall Configuration

If using a firewall, allow necessary ports:

```bash
# Allow HTTP (80) and HTTPS (443)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Allow Reverb WebSocket port (8080)
sudo ufw allow 8080/tcp

# Enable firewall
sudo ufw enable
```

---

## Step 15: Final Verification

```bash
# Check application status
php artisan about

# Test database connection
php artisan tinker
# Then run: DB::connection()->getPdo();

# Check queue status
php artisan queue:work --once

# Check scheduled tasks
php artisan schedule:list

# View logs
tail -f storage/logs/laravel.log
```

---

## Step 16: Update Application (Future Deployments)

When you need to update the application:

```bash
# Navigate to project directory
cd /path/to/boardsmemberportal

# Pull latest changes
git pull origin main

# Install/update dependencies
composer install --optimize-autoloader --no-dev
npm install
npm run build

# Run migrations
php artisan migrate --force

# Clear and cache
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart services
sudo systemctl restart reverb
sudo supervisorctl restart laravel-worker:*
# or
sudo supervisorctl restart reverb:*
```

---

## Troubleshooting

### Permission Issues

```bash
# Fix ownership
sudo chown -R www-data:www-data /path/to/boardsmemberportal
sudo chmod -R 755 /path/to/boardsmemberportal
sudo chmod -R 775 /path/to/boardsmemberportal/storage
sudo chmod -R 775 /path/to/boardsmemberportal/bootstrap/cache
```

### Clear All Caches

```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
php artisan optimize:clear
```

### Check Logs

```bash
# Application logs
tail -f storage/logs/laravel.log

# Reverb logs
tail -f storage/logs/reverb.log

# Queue worker logs
tail -f storage/logs/worker.log

# Web server error logs
tail -f /var/log/apache2/error.log
# or
tail -f /var/log/nginx/error.log
```

### Database Connection Issues

```bash
# Test database connection
php artisan tinker
# Then: DB::connection()->getPdo();

# Check .env file
cat .env | grep DB_
```

### Reverb Connection Issues

- Ensure port 8080 is open in firewall
- Check Reverb service is running: `sudo systemctl status reverb`
- Verify REVERB_* variables in .env
- Check browser console for WebSocket connection errors

---

## Security Checklist

- [ ] Set `APP_DEBUG=false` in production
- [ ] Use strong database passwords
- [ ] Enable HTTPS/SSL
- [ ] Set proper file permissions
- [ ] Keep dependencies updated
- [ ] Use environment variables for sensitive data
- [ ] Enable firewall
- [ ] Regular backups of database and files
- [ ] Keep Laravel and packages updated

---

## Backup Strategy

### Database Backup

```bash
# Create backup script
nano /path/to/backup-db.sh
```

Add:

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u your_db_user -p'your_db_password' your_database_name > /path/to/backups/db_backup_$DATE.sql
```

Make executable and schedule:

```bash
chmod +x /path/to/backup-db.sh
crontab -e
# Add: 0 2 * * * /path/to/backup-db.sh
```

### File Backup

```bash
# Backup storage and important files
tar -czf /path/to/backups/files_backup_$(date +%Y%m%d).tar.gz /path/to/boardsmemberportal/storage
```

---

## Support

For issues or questions:
- Check Laravel documentation: https://laravel.com/docs
- Check Laravel Reverb documentation: https://laravel.com/docs/reverb
- Review application logs in `storage/logs/`

---

**Note:** Replace all `/path/to/boardsmemberportal` with your actual project path, and all `your-domain.com` with your actual domain name.

