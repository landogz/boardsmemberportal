# Laravel Application Deployment Instructions

Complete guide for deploying the Board Member Portal to AlwaysData hosting.

**Your Configuration:**
- Domain: `landogz.alwaysdata.net`
- Web Root: `/www`
- Project Path: `/www/boardsmemberportal`

## Prerequisites

- SSH access to AlwaysData server
- PHP 8.2+ (available on AlwaysData)
- Composer installed
- MySQL/MariaDB database (create via AlwaysData admin panel)
- Node.js and npm (for asset compilation)
- Git installed on server

---

## Step 1: Connect to Your AlwaysData Server

```bash
ssh your-username@ssh-landogz.alwaysdata.net
# or use the SSH credentials from your AlwaysData admin panel
```

---

## Step 2: Clone the Repository

```bash
# Navigate to your web root directory
cd /www

# Clone the repository
git clone https://github.com/landogz/boardsmemberportal.git

# Navigate into the project directory
cd boardsmemberportal
```

---

## Step 3: Install PHP Dependencies

```bash
# Install Composer dependencies
composer install --optimize-autoloader --no-dev

# If composer is not installed globally, download it first:
# curl -sS https://getcomposer.org/installer | php
# php composer.phar install --optimize-autoloader --no-dev
```

---

## Step 4: Environment Configuration

```bash
# Copy the environment file
cp .env.example .env

# Generate application key
php artisan key:generate

# Edit the .env file with your configuration
nano .env
# or
vi .env
```

### Required .env Configuration:

```env
APP_NAME="Board Member Portal"
APP_ENV=production
APP_KEY=base64:... (generated by key:generate)
APP_DEBUG=false
APP_URL=https://landogz.alwaysdata.net

LOG_CHANNEL=stack
LOG_LEVEL=error

DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=your_database_name
DB_USERNAME=your_database_user
DB_PASSWORD=your_database_password

BROADCAST_DRIVER=reverb
REVERB_APP_ID=your-app-id
REVERB_APP_KEY=your-app-key
REVERB_APP_SECRET=your-app-secret
REVERB_HOST=landogz.alwaysdata.net
REVERB_PORT=8080
REVERB_SCHEME=https

CACHE_DRIVER=file
QUEUE_CONNECTION=database
SESSION_DRIVER=file
SESSION_LIFETIME=120

MAIL_MAILER=smtp
MAIL_HOST=your-smtp-host
MAIL_PORT=587
MAIL_USERNAME=your-email@domain.com
MAIL_PASSWORD=your-email-password
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=noreply@your-domain.com
MAIL_FROM_NAME="${APP_NAME}"

FILESYSTEM_DISK=local
```

**Important:** Replace all placeholder values with your actual configuration.

---

## Step 5: Database Setup

```bash
# Create database (if not already created via cPanel/phpMyAdmin)
# You may need to do this via your hosting control panel

# Run migrations
php artisan migrate --force

# Seed the database (optional, for initial setup)
php artisan db:seed --class=RolePermissionSeeder
php artisan db:seed --class=GovernmentAgencySeeder
```

---

## Step 6: Storage and Cache Setup

```bash
# Create symbolic link for storage
php artisan storage:link

# Clear and cache configuration
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Clear application cache
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

---

## Step 7: Install and Build Frontend Assets

```bash
# Install Node.js dependencies
npm install

# Build production assets
npm run build

# Or if you need to watch for changes during development:
# npm run dev
```

---

## Step 8: Set Permissions

```bash
# Set proper permissions for storage and cache directories
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache

# If www-data doesn't work, try your web server user:
# chown -R apache:apache storage bootstrap/cache
# or
# chown -R nginx:nginx storage bootstrap/cache
```

---

## Step 9: Configure Web Server

### For AlwaysData (Apache)

AlwaysData uses Apache and automatically serves from `/www` directory. You need to configure it to point to the `public` folder.

**Option 1: Create a symbolic link (Recommended)**

```bash
# Navigate to www directory
cd /www

# Remove or rename existing index if needed
# mv index.html index.html.bak (if exists)

# Create symbolic link to Laravel public folder
ln -s /www/boardsmemberportal/public public_html
# or if AlwaysData uses a different directory name, adjust accordingly
```

**Option 2: Configure AlwaysData Admin Panel**

1. Log in to your AlwaysData admin panel: https://admin.alwaysdata.com
2. Go to **Web > Sites**
3. Edit your site configuration
4. Set the **Document root** to: `/www/boardsmemberportal/public`
5. Save the configuration

**Option 3: Use .htaccess redirect (if needed)**

If AlwaysData serves from `/www` directly, create an `.htaccess` in `/www`:

```apache
RewriteEngine On
RewriteCond %{REQUEST_URI} !^/boardsmemberportal/public/
RewriteRule ^(.*)$ /boardsmemberportal/public/$1 [L]
```

### For Nginx (if AlwaysData offers Nginx option)

```nginx
server {
    listen 80;
    server_name landogz.alwaysdata.net;
    root /www/boardsmemberportal/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

---

## Step 10: Setup Laravel Reverb (WebSocket Server)

### Install Reverb

```bash
# Reverb should already be in composer.json, but if not:
composer require laravel/reverb

# Publish Reverb configuration
php artisan reverb:install
```

### Configure Reverb

Edit `config/reverb.php` or set in `.env`:

```env
REVERB_APP_ID=your-app-id
REVERB_APP_KEY=your-app-key
REVERB_APP_SECRET=your-app-secret
REVERB_HOST=landogz.alwaysdata.net
REVERB_PORT=8080
REVERB_SCHEME=https
```

### Run Reverb on AlwaysData

**Important:** AlwaysData may have restrictions on running long-lived processes. Check your plan's limitations.

**Option 1: Using AlwaysData's Process Manager (Recommended)**

1. Log in to AlwaysData admin panel
2. Go to **Advanced > Processes**
3. Create a new process:
   - **Name:** `reverb`
   - **Command:** `php /www/boardsmemberportal/artisan reverb:start --host=0.0.0.0 --port=8080`
   - **Working directory:** `/www/boardsmemberportal`
   - **Auto-restart:** Yes

**Option 2: Using Supervisor (if available)**

```bash
# Create supervisor config
nano ~/supervisor/reverb.conf
```

Add:

```ini
[program:reverb]
process_name=%(program_name)s_%(process_num)02d
command=php /www/boardsmemberportal/artisan reverb:start --host=0.0.0.0 --port=8080
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=your-username
numprocs=1
redirect_stderr=true
stdout_logfile=/www/boardsmemberportal/storage/logs/reverb.log
stopwaitsecs=3600
```

**Option 3: Using screen/tmux (Temporary solution)**

```bash
# Install screen if not available
# Start a screen session
screen -S reverb

# Run Reverb
cd /www/boardsmemberportal
php artisan reverb:start --host=0.0.0.0 --port=8080

# Detach: Press Ctrl+A then D
# Reattach: screen -r reverb
```

**Note:** AlwaysData may require you to use their process manager or may have restrictions on WebSocket servers. Check with AlwaysData support if Reverb doesn't work.

### Alternative: Run Reverb with Supervisor

Install Supervisor:

```bash
sudo apt-get install supervisor
```

Create supervisor config:

```bash
sudo nano /etc/supervisor/conf.d/reverb.conf
```

Add:

```ini
[program:reverb]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/boardsmemberportal/artisan reverb:start --host=0.0.0.0 --port=8080
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=1
redirect_stderr=true
stdout_logfile=/path/to/boardsmemberportal/storage/logs/reverb.log
stopwaitsecs=3600
```

Start supervisor:

```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start reverb:*
```

---

## Step 11: Setup Queue Workers

Laravel uses queues for background jobs. Set up a queue worker:

### Using AlwaysData Process Manager (Recommended)

1. Log in to AlwaysData admin panel
2. Go to **Advanced > Processes**
3. Create a new process:
   - **Name:** `laravel-worker`
   - **Command:** `php /www/boardsmemberportal/artisan queue:work --sleep=3 --tries=3 --max-time=3600`
   - **Working directory:** `/www/boardsmemberportal`
   - **Auto-restart:** Yes

### Using Supervisor (if available in your home directory)

```bash
# Create supervisor config in your home directory
nano ~/supervisor/laravel-worker.conf
```

Add:

```ini
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /www/boardsmemberportal/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=your-username
numprocs=1
redirect_stderr=true
stdout_logfile=/www/boardsmemberportal/storage/logs/worker.log
stopwaitsecs=3600
```

**Note:** AlwaysData may not allow systemd services. Use their process manager instead.

---

## Step 12: Setup Task Scheduler (Cron)

Laravel's scheduler needs to run every minute. Add to crontab:

```bash
crontab -e
```

Add this line:

```cron
* * * * * cd /www/boardsmemberportal && php artisan schedule:run >> /dev/null 2>&1
```

**Alternative: Use AlwaysData's Cron Jobs**

1. Log in to AlwaysData admin panel
2. Go to **Advanced > Cron**
3. Create a new cron job:
   - **Command:** `cd /www/boardsmemberportal && php artisan schedule:run`
   - **Schedule:** `* * * * *` (every minute)

---

## Step 13: SSL Certificate (HTTPS)

### SSL Certificate on AlwaysData

AlwaysData provides free SSL certificates via Let's Encrypt:

1. Log in to AlwaysData admin panel
2. Go to **Web > Sites**
3. Click on your site (`landogz.alwaysdata.net`)
4. Go to **SSL/TLS** section
5. Enable **Let's Encrypt** certificate
6. Save the configuration

AlwaysData will automatically renew the certificate.

### Update .env for HTTPS

```env
APP_URL=https://landogz.alwaysdata.net
REVERB_SCHEME=https
```

---

## Step 14: Firewall Configuration

If using a firewall, allow necessary ports:

```bash
# Allow HTTP (80) and HTTPS (443)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# Allow Reverb WebSocket port (8080)
sudo ufw allow 8080/tcp

# Enable firewall
sudo ufw enable
```

---

## Step 15: Final Verification

```bash
# Check application status
php artisan about

# Test database connection
php artisan tinker
# Then run: DB::connection()->getPdo();

# Check queue status
php artisan queue:work --once

# Check scheduled tasks
php artisan schedule:list

# View logs
tail -f storage/logs/laravel.log
```

---

## Step 16: Update Application (Future Deployments)

When you need to update the application:

```bash
# Navigate to project directory
cd /www/boardsmemberportal

# Pull latest changes
git pull origin main

# Install/update dependencies
composer install --optimize-autoloader --no-dev
npm install
npm run build

# Run migrations
php artisan migrate --force

# Clear and cache
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Restart services (via AlwaysData admin panel)
# Go to Advanced > Processes and restart:
# - reverb
# - laravel-worker
```

---

## Troubleshooting

### Permission Issues

```bash
# Fix permissions (AlwaysData uses your user account)
chmod -R 755 /www/boardsmemberportal
chmod -R 775 /www/boardsmemberportal/storage
chmod -R 775 /www/boardsmemberportal/bootstrap/cache

# If you still have issues, contact AlwaysData support
```

### Clear All Caches

```bash
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
php artisan optimize:clear
```

### Check Logs

```bash
# Application logs
tail -f /www/boardsmemberportal/storage/logs/laravel.log

# Reverb logs
tail -f /www/boardsmemberportal/storage/logs/reverb.log

# Queue worker logs
tail -f /www/boardsmemberportal/storage/logs/worker.log

# AlwaysData web server logs (via admin panel)
# Go to Web > Sites > your-site > Logs
# Or check: ~/logs/web/
```

### Database Connection Issues

```bash
# Test database connection
php artisan tinker
# Then: DB::connection()->getPdo();

# Check .env file
cat .env | grep DB_
```

### Reverb Connection Issues

- Ensure port 8080 is open in firewall
- Check Reverb service is running: `sudo systemctl status reverb`
- Verify REVERB_* variables in .env
- Check browser console for WebSocket connection errors

---

## Security Checklist

- [ ] Set `APP_DEBUG=false` in production
- [ ] Use strong database passwords
- [ ] Enable HTTPS/SSL
- [ ] Set proper file permissions
- [ ] Keep dependencies updated
- [ ] Use environment variables for sensitive data
- [ ] Enable firewall
- [ ] Regular backups of database and files
- [ ] Keep Laravel and packages updated

---

## Backup Strategy

### Database Backup

**Option 1: Via AlwaysData Admin Panel**
1. Go to **Databases > MySQL**
2. Click on your database
3. Use the **Backup** feature

**Option 2: Via Command Line**

```bash
# Create backup directory
mkdir -p ~/backups

# Create backup script
nano ~/backups/backup-db.sh
```

Add (replace with your actual database credentials):

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u your_db_user -p'your_db_password' your_database_name > ~/backups/db_backup_$DATE.sql
# Keep only last 7 days
find ~/backups -name "db_backup_*.sql" -mtime +7 -delete
```

Make executable and schedule:

```bash
chmod +x ~/backups/backup-db.sh
crontab -e
# Add: 0 2 * * * ~/backups/backup-db.sh
```

### File Backup

```bash
# Create backup directory
mkdir -p ~/backups

# Backup storage and important files
tar -czf ~/backups/files_backup_$(date +%Y%m%d).tar.gz /www/boardsmemberportal/storage

# Keep only last 7 days
find ~/backups -name "files_backup_*.tar.gz" -mtime +7 -delete
```

---

## Support

For issues or questions:
- Check Laravel documentation: https://laravel.com/docs
- Check Laravel Reverb documentation: https://laravel.com/docs/reverb
- Review application logs in `storage/logs/`

---

---

## AlwaysData-Specific Notes

1. **Document Root:** AlwaysData serves from `/www`. Configure the site to point to `/www/boardsmemberportal/public` in the admin panel.

2. **Process Management:** Use AlwaysData's process manager (Advanced > Processes) for Reverb and queue workers instead of systemd.

3. **Cron Jobs:** Use AlwaysData's cron interface (Advanced > Cron) or your user crontab.

4. **SSL:** AlwaysData provides free Let's Encrypt certificates via the admin panel.

5. **Database:** Create your MySQL database via AlwaysData admin panel (Databases > MySQL).

6. **PHP Version:** AlwaysData supports multiple PHP versions. Select PHP 8.2+ in your site configuration.

7. **File Permissions:** Files are owned by your user account. Use `chmod` for permissions, not `chown`.

8. **Logs:** Access web server logs via AlwaysData admin panel or in `~/logs/web/`.

9. **SSH Access:** Use `ssh your-username@ssh-landogz.alwaysdata.net` to connect.

10. **Port Restrictions:** AlwaysData may restrict certain ports. Check with support if Reverb (port 8080) doesn't work.

---

**Your Configuration Summary:**
- Domain: `landogz.alwaysdata.net`
- Project Path: `/www/boardsmemberportal`
- Public Path: `/www/boardsmemberportal/public`
- Admin Panel: https://admin.alwaysdata.com

